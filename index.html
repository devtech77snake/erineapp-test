<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<title>Bus Station</title>
	</head>
	<body>
		<div class="container p-4">
			<h1 class="text-center">Bus List</h1>
			<div id="bus_list" class="container pt-4 text-center">
				<div class="row p-2">
					<div class="col-1">Number</div>
					<div class="col-3">Driver Name</div>
					<div class="col-3">Left Seats/Total Seats</div>
					<div class="col-2">Bus Status</div>
					<div class="col-3">Action</div>
				</div>
			</div>
		</div>

		<script>
			window.onload = () => {
				console.log('Welcome Bus Station');
				getBusList();
			};

			const getBusList = () => {
				const apiUrl = 'http://localhost:8000/bus/list';
				fetch(apiUrl)
					.then((res) => {
						if (!res.ok) {
							throw new Error('Network resonse was not ok');
						}
						const response = res.json();
						return response;
					})
					.then((data) => {
						const buses = data.bus_list;
						const csrftoken = data.csrftoken;
						sessionStorage.setItem('csrftoken', csrftoken);
						var bus_list = document.getElementById('bus_list');
						buses.forEach((x) => {
							var bus = document.createElement('div');
							bus.className = 'row p-2';
							var number = document.createElement('div');
							number.className = 'col-1';
							number.innerText = x.number;
							var driver_name = document.createElement('div');
							driver_name.className = 'col-3';
							driver_name.innerText = x.driver_name;
							var seats = document.createElement('div');
							seats.className = 'col-3';
							seats.innerText = x.available_seats + '/' + x.max_seats;
							var status = document.createElement('div');
							status.className = 'col-2';
							status.innerText = x.status_display;
							var action = document.createElement('div');
							action.className = 'col-3';
							var button = document.createElement('button');
							button.addEventListener('click', () => reserveSeat(x.id));
							button.innerText = 'Reserve';
							if (x.available_seats == 0) {
								button.disabled = true;
								button.innerText = 'No seats available';
								bus.className += ' bg-danger';
							} else if (x.available_seats < 10) {
								bus.className += ' bg-warning';
							} else if (x.status == 2 || x.status == 3) {
								bus.className += ' bg-info';
							} else if (x.status == 0 || x.status == 1) {
								bus.className += ' bg-success';
							} else {
							}
							action.appendChild(button);

							bus.appendChild(number);
							bus.appendChild(driver_name);
							bus.appendChild(seats);
							bus.appendChild(status);
							bus.appendChild(action);

							bus_list.appendChild(bus);
						});
					})
					.catch((err) => {
						console.log('===> error getBusList ', err);
					});
			};

			const reserveSeat = (busId) => {
				console.log('===> reserve seat bus id: ', busId);
				const apiUrl = 'http://localhost:8000/bus/reserve';
				console.log(sessionStorage.getItem('csrftoken'), busId);
				fetch(apiUrl, {
					method: 'POST',
					headers: {
						'content-type': 'x-www-form-urlencoded',
						'X-CSFTToken': sessionStorage.getItem('csrftoken'),
					},
					// mode: 'same-origin',
					body: { id: busId },
				})
					.then((res) => {
						if (!res.ok) {
							throw new Error('Network resonse was not ok');
						}
						return res.json();
					})
					.then((data) => {
						console.log(data);
					})
					.catch((err) => {
						console.log('===> error reserveSeat ', err);
					});
			};

			const unreserveSeat = (busId) => {
				const apiUrl = 'http://localhost:8000/bus/unreserve';
				fetch(apiUrl)
					.then((res) => {
						if (!res.ok) {
							throw new Error('Network resonse was not ok');
						}
						return res.json();
					})
					.then((data) => {
						console.log(data);
					})
					.catch((err) => {
						console.log('===> error unreserveSeat ', err);
					});
			};

			const getCookie = () => {
				var csrftoken = null;
				const cookies = document.cookie.split(';');
				for (var cookie of cookies) {
					const [key, value] = cookie.split('=').map((c) => c.trim());
					if (key == 'csrftoken') {
						csrftoken = value;
						break;
					}
				}
				return csrftoken;
			};
		</script>
	</body>
</html>
